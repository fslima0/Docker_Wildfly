image: maven:latest

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"

cache:
  paths:
    - .m2/repository/

stages:
 - build
 - test
 - package
 - release
 - deploy-to-test

.tests:
  rules:
    - if: '$CI_COMMIT_TAG =~ /^.*-rc.*$/'

build:
 stage: build
 script:
   - mvn compile 

test:
 stage: test
 script:
   - mvn test

package:
 extends: .tests
 stage: package
 script:
   - mvn -DskipTests=true package
 artifacts:
   paths:
       - target/*.jar

release:
 extends: .tests
 stage: release
 dependencies:
   - build
   - test
   - package
 image: docker:20.10.7
 services:
  - docker:20.10.7-dind
 before_script:
   - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
 script:
   - docker pull $CI_REGISTRY_IMAGE:rc || true
   - docker build --cache-from $CI_REGISTRY_IMAGE:rc --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME --tag $CI_REGISTRY_IMAGE:rc .
   - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME
   - docker push $CI_REGISTRY_IMAGE:rc

deploy:
 extends: .tests
 stage: deploy-to-test
 dependencies:
   - release
 image: docker:20.10.7
 services:
  - docker:20.10.7-dind
 script:
   - docker run -d -p 8080:8080 -p 9990:9990 $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME
